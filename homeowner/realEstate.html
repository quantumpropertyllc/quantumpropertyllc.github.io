<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>北卡房产投资分析 Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --sub: #8e8e93;
      --primary: #5856d6; --accent: #007aff; --border: rgba(0,0,0,0.1);
      --input-bg: #f2f2f7; --success: #34c759; --warning: #ff9500;
      --btn-link-bg: rgba(0,122,255,0.1); --btn-link-text: #007aff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000; --card: #1c1c1e; --text: #ffffff; --sub: #8e8e93;
        --primary: #5e5ce6; --accent: #0a84ff; --border: rgba(255,255,255,0.1);
        --input-bg: #2c2c2e; --btn-link-bg: rgba(10,132,255,0.2); --btn-link-text: #0a84ff;
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--bg); color: var(--text); padding-bottom: 50px;
      padding-top: env(safe-area-inset-top);
    }
    .container { max-width: 800px; margin: auto; padding: 0 16px; }

    header { 
      padding: 30px 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
      color: #fff; border-radius: 0 0 24px 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 1.5rem; }
    
    .section-title { margin: 25px 0 10px 5px; font-size: 1rem; font-weight: 700; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }

    .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px var(--border); }
    
    .calc-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .calc-group { display: flex; flex-direction: column; }
    .calc-group label { font-size: 0.75rem; color: var(--sub); margin-bottom: 4px; font-weight: 600; }
    .calc-group input { 
      padding: 12px; border-radius: 10px; border: none; background: var(--input-bg); 
      color: var(--text); font-size: 1rem; outline: none; border: 1px solid transparent;
    }
    .calc-btn { 
      grid-column: span 2; padding: 15px; background: var(--primary); color: white; 
      border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; margin-top: 10px;
    }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #propertyList { width: 100%; border-collapse: collapse; min-width: 600px; }
    #propertyList th { background: var(--input-bg); padding: 12px 8px; font-size: 0.75rem; text-align: left; cursor: pointer; }
    #propertyList td { padding: 12px 8px; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
    
    .roi-badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; background: var(--success); color: white; }
    .btn-delete { color: #ff3b30; font-weight: 600; cursor: pointer; }

    #chartArea { display: none; margin-top: 20px; text-align: center; }
    canvas { max-width: 300px; margin: auto; }

    /* 工具链接样式 */
    .info-label { display: block; font-size: 0.75rem; color: var(--sub); margin-bottom: 6px; font-weight: 600; }
    .btn-link { 
      display: inline-block; background: var(--btn-link-bg); color: var(--btn-link-text); 
      padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; margin-right: 6px; margin-bottom: 8px;
      text-decoration: none; font-weight: 500;
    }
    .tool-group { margin-bottom: 15px; }

    /* 税率表样式 */
    .tax-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .tax-item { 
      background: var(--input-bg); padding: 10px; border-radius: 10px; font-size: 0.8rem; 
      cursor: pointer; border: 1px solid transparent; transition: 0.2s;
    }
    .tax-item:active { background: var(--btn-link-bg); border-color: var(--accent); }
    .tax-item b { color: var(--primary); display: block; font-size: 0.9rem; }
  </style>
</head>
<body>

<header>
  <h1>北卡房产投资分析 Pro</h1>
  <p>计算 ROI & 尽职调查集成工具</p>
</header>

<div class="container">
  
  <div class="card">
    <div class="calc-form">
      <div class="calc-group" style="grid-column: span 2;"><label>房源名称</label><input type="text" id="propName" placeholder="例: Ballantyne Condo"></div>
      <div class="calc-group"><label>房价 ($)</label><input type="number" inputmode="decimal" id="housePrice" value="500000" oninput="autoUpdateTax()"></div>
      <div class="calc-group"><label>首付 ($)</label><input type="number" inputmode="decimal" id="downpayment" value="100000"></div>
      <div class="calc-group"><label>贷款利率 (%)</label><input type="number" inputmode="decimal" id="mortgageRate" value="7.2" step="0.01"></div>
      <div class="calc-group"><label>年房产税 ($)</label><input type="number" inputmode="decimal" id="annualTax" value="4500"></div>
      <div class="calc-group"><label>年保险费 ($)</label><input type="number" inputmode="decimal" id="annualIns" value="1200"></div>
      <div class="calc-group"><label>月 HOA ($)</label><input type="number" inputmode="decimal" id="monthlyHOA" value="50"></div>
      <div class="calc-group"><label>预估月租金 ($)</label><input type="number" inputmode="decimal" id="expectedRent" value="3200"></div>
      <div class="calc-group"><label>机会成本率 (%)</label><input type="number" inputmode="decimal" id="tbillRate" value="5.2"></div>
      <button class="calc-btn" onclick="addProperty()">＋ 添加并分析房源</button>
    </div>
  </div>

  <div class="section-title">北卡热门郡税率参考 (点击自动计算)</div>
  <div class="card">
    <span class="info-label">点击下方区域自动预填“年房产税”（基于当前房价）</span>
    <div class="tax-grid">
      <div class="tax-item" onclick="applyTaxRate(0.0095, 'Mecklenburg')"><b>Mecklenburg (夏村)</b>约 0.95%</div>
      <div class="tax-item" onclick="applyTaxRate(0.0065, 'Union')"><b>Union (Marvin/Wed)</b>约 0.65%</div>
      <div class="tax-item" onclick="applyTaxRate(0.0102, 'Wake')"><b>Wake (Raleigh/Cary)</b>约 1.02%</div>
      <div class="tax-item" onclick="applyTaxRate(0.0085, 'Durham')"><b>Durham</b>约 0.85%</div>
      <div class="tax-item" onclick="applyTaxRate(0.0075, 'Cabarrus')"><b>Cabarrus (Concord)</b>约 0.75%</div>
      <div class="tax-item" onclick="applyTaxRate(0.0090, 'Guilford')"><b>Guilford (Greensboro)</b>约 0.90%</div>
    </div>
    <p style="font-size: 0.65rem; color: var(--sub); margin-top: 10px;">* 以上税率仅为估算，具体包含市、郡及专项税，请以官方账单为准。</p>
  </div>

  <div id="chartArea" class="card">
    <h3 id="chartTitle" style="margin-top:0; font-size:1rem;">支出结构分析</h3>
    <canvas id="expenseChart"></canvas>
  </div>

  <div class="section-title">对比分析表</div>
  <div class="card" style="padding:10px">
    <div class="table-container">
      <table id="propertyList">
        <thead>
          <tr>
            <th onclick="sortTable('name')">名称 ↕️</th>
            <th onclick="sortTable('totalOut')">月支 ↕️</th>
            <th onclick="sortTable('beRent')">盈亏点 ↕️</th>
            <th onclick="sortTable('cocROI')">Cash ROI ↕️</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="section-title">尽职调查工具包 (Due Diligence)</div>
  <div class="card">
    <div class="tool-group">
      <span class="info-label">官方法律记录 (法庭、逮捕、驱逐)</span>
      <a href="https://portal-nc.tylertech.cloud/Portal/" class="btn-link">北卡法庭记录</a>
      <a href="https://mecksheriffweb.mecklenburgcountync.gov" class="btn-link">夏村逮捕记录</a>
      <a href="https://mcsop.permitium.com/sop/searchpage" class="btn-link">夏村 Eviction 记录</a>
    </div>

    <div class="tool-group">
      <span class="info-label">租客背调与信用调查</span>
      <a href="https://www.fastpeoplesearch.com" class="btn-link">FastPeopleSearch</a>
      <a href="https://www.mysmartmove.com/SmartMove/login/landlord_new_application.page" class="btn-link">TransUnion SmartMove</a>
      <a href="https://tenantbackgroundsearch.com" class="btn-link">租客调查网</a>
    </div>

    <div class="tool-group">
      <span class="info-label">产权 (Deed) 与选民核实</span>
      <a href="https://vt.ncsbe.gov/RegLkup" class="btn-link">北卡选民</a>
      <a href="https://voterrecords.com/" class="btn-link">全美选民</a>
      <a href="https://property.spatialest.com/nc/mecklenburg#/" class="btn-link">夏村 Deed</a>
      <a href="https://www.unionconcrod.org/" class="btn-link">Union Deed</a>
      <a href="https://property.spatialest.com/nc/union#/" class="btn-link">Union 地址查</a>
    </div>
  </div>

</div>

<script>
let properties = JSON.parse(localStorage.getItem('nc_invest_props_pro_v2') || '[]');
let expenseChart = null;
let currentSelectedRate = null;

function hapticFeedback() { if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(10); }

// 郡税率应用逻辑
function applyTaxRate(rate, countyName) {
  hapticFeedback();
  currentSelectedRate = rate;
  const price = +document.getElementById('housePrice').value;
  const calculatedTax = Math.round(price * rate);
  document.getElementById('annualTax').value = calculatedTax;
  
  // 更新房源名称预览（可选）
  const nameInput = document.getElementById('propName');
  if(!nameInput.value || nameInput.value.includes("郡房源")) {
    nameInput.value = countyName + "郡房源";
  }
}

// 房价变动时同步更新税费（如果已选择了郡）
function autoUpdateTax() {
  if (currentSelectedRate) {
    const price = +document.getElementById('housePrice').value;
    document.getElementById('annualTax').value = Math.round(price * currentSelectedRate);
  }
}

function calculateROI(p) {
  const loan = p.housePrice - p.downpayment;
  const r = p.mortgageRate / 100 / 12;
  const n = 30 * 12;
  const monthlyPI = (loan > 0 && r > 0) ? loan * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1) : 0;
  const monthlyTaxIns = (p.annualTax + p.annualIns) / 12;
  const maintenance = (p.housePrice * 0.008) / 12;
  const totalOut = monthlyPI + monthlyTaxIns + maintenance + p.monthlyHOA;
  const oppCost = p.downpayment * (p.tbillRate / 100) / 12;
  const beRent = totalOut + oppCost;
  const netCashFlow = (p.expectedRent - totalOut) * 12;
  const cocROI = p.downpayment > 0 ? (netCashFlow / p.downpayment * 100).toFixed(2) : "N/A";
  return { ...p, monthlyPI, monthlyTaxIns, maintenance, totalOut, oppCost, beRent, cocROI };
}

function addProperty() {
  hapticFeedback();
  const p = {
    id: Date.now(),
    name: document.getElementById('propName').value || '新房源',
    housePrice: +document.getElementById('housePrice').value,
    downpayment: +document.getElementById('downpayment').value,
    mortgageRate: +document.getElementById('mortgageRate').value,
    annualTax: +document.getElementById('annualTax').value,
    annualIns: +document.getElementById('annualIns').value,
    monthlyHOA: +document.getElementById('monthlyHOA').value,
    expectedRent: +document.getElementById('expectedRent').value,
    tbillRate: +document.getElementById('tbillRate').value
  };
  properties.push(p);
  saveAndRender();
  showChart(p.id);
  // 重置郡选择
  currentSelectedRate = null;
}

function deleteProp(id) {
  properties = properties.filter(p => p.id !== id);
  saveAndRender();
  document.getElementById('chartArea').style.display = 'none';
}

function saveAndRender() {
  localStorage.setItem('nc_invest_props_pro_v2', JSON.stringify(properties));
  const body = document.getElementById('tableBody');
  body.innerHTML = '';
  properties.forEach(p => {
    const c = calculateROI(p);
    const tr = document.createElement('tr');
    tr.onclick = () => showChart(p.id);
    tr.innerHTML = `
      <td><b>${c.name}</b></td>
      <td>$${c.totalOut.toFixed(0)}</td>
      <td style="color:var(--primary);font-weight:700">$${c.beRent.toFixed(0)}</td>
      <td><span class="roi-badge">${c.cocROI}%</span></td>
      <td><span class="btn-delete" onclick="event.stopPropagation(); deleteProp(${p.id})">删除</span></td>
    `;
    body.appendChild(tr);
  });
}

function showChart(id) {
  const p = properties.find(x => x.id === id);
  if(!p) return;
  const c = calculateROI(p);
  document.getElementById('chartArea').style.display = 'block';
  document.getElementById('chartTitle').innerText = `${c.name} 月支出预览`;
  const ctx = document.getElementById('expenseChart').getContext('2d');
  if(expenseChart) expenseChart.destroy();
  expenseChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['本息', '税保', 'HOA', '维护', '机会成本'],
      datasets: [{
        data: [c.monthlyPI, c.monthlyTaxIns, c.monthlyHOA, c.maintenance, c.oppCost],
        backgroundColor: ['#5856d6', '#ff9500', '#ff3b30', '#34c759', '#8e8e93']
      }]
    },
    options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
  });
}

function sortTable(key) {
  properties.sort((a,b) => {
    const valA = key === 'name' ? a[key] : parseFloat(calculateROI(a)[key]);
    const valB = key === 'name' ? b[key] : parseFloat(calculateROI(b)[key]);
    return valA > valB ? 1 : -1;
  });
  saveAndRender();
}

window.onload = saveAndRender;
</script>

</body>
</html>
